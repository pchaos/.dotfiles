#!/usr/bin/env zsh
# Last Modified: 2025-11-06 12:04:26

# stow (GNU Stow) version 2.3.1

# SYNOPSIS:

#     stow [OPTION ...] [-D|-S|-R] PACKAGE ... [-D|-S|-R] PACKAGE ...

# OPTIONS:

#     -d DIR, --dir=DIR     Set stow dir to DIR (default is current dir)
#     -t DIR, --target=DIR  Set target to DIR (default is parent of stow dir)

#     -S, --stow            Stow the package names that follow this option
#     -D, --delete          Unstow the package names that follow this option
#     -R, --restow          Restow (like stow -D followed by stow -S)

#     --ignore=REGEX        Ignore files ending in this Perl regex
#     --defer=REGEX         Don't stow files beginning with this Perl regex
#                           if the file is already stowed to another package
#     --override=REGEX      Force stowing files beginning with this Perl regex
#                           if the file is already stowed to another package
#     --adopt               (Use with care!)  Import existing files into stow package
#                           from target.  Please read docs before using.
#     -p, --compat          Use legacy algorithm for unstowing

#     -n, --no, --simulate  Do not actually make any filesystem changes
#     -v, --verbose[=N]     Increase verbosity (levels are from 0 to 5;
#                             -v or --verbose adds 1; --verbose=N sets level)
#     -V, --version         Show stow version number
#     -h, --help            Show this help

# Report bugs to: bug-stow@gnu.org
# Stow home page: <http://www.gnu.org/software/stow/>
# General help using GNU software: <http://www.gnu.org/gethelp/>

echo "Stowing Dotfiles...";

if [[ -z $STOW_FOLDERS ]]; then
  # STOW_FOLDERS="bash,conda,git,htinsight,lvim,tmux"
  STOW_FOLDERS="bash,conda,git,lvim,tmux"
fi

if [[ -z $DOTFILES ]]; then
  DOTFILES=$HOME/.dotfiles
fi
echo $STOW_FOLDERS $DOTFILES

# è°ƒç”¨åŒç›®å½•ä¸‹çš„ï¼šinstall
STOW_FOLDERS=$STOW_FOLDERS DOTFILES=$DOTFILES $DOTFILES/install

# sleep 10

# æ£€æŸ¥powerlevel10kä¸»é¢˜
THEME_DIR="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"

# æ£€æŸ¥ä¸»é¢˜ç›®å½•æ˜¯å¦å­˜åœ¨
if [ ! -d "$THEME_DIR" ]; then
  echo "â³ æ­£åœ¨å…‹éš†powerlevel10kä¸»é¢˜..."
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k

  # éªŒè¯å…‹éš†ç»“æžœ
  if [ $? -eq 0 ]; then
    echo "âœ… ä¸»é¢˜å®‰è£…æˆåŠŸï¼"
    ls -la "$THEME_DIR" | head -5  # æ˜¾ç¤ºå‰5ä¸ªæ–‡ä»¶éªŒè¯
  else
    echo "âŒ å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥å’Œgité…ç½®"
    exit 1
  fi
else
  echo "â„¹ï¸ ä¸»é¢˜å·²å­˜åœ¨ï¼Œç›®å½•å†…å®¹ï¼š"
  ls -la "$THEME_DIR" | head -5
fi

# æ£€æŸ¥å…³é”®æ–‡ä»¶
THEME_FILE="$THEME_DIR/powerlevel10k.zsh-theme"
[ -f "$THEME_FILE" ] && echo "ðŸ” æ‰¾åˆ°ä¸»é¢˜æ–‡ä»¶: $THEME_FILE" || echo "âš ï¸ ç¼ºå°‘ä¸»é¢˜æ–‡ä»¶"

# fcitx5 è¾“å…¥æ³•åˆ‡æ¢,ç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è¦æ‰§è¡Œ
# sudo update-desktop-database /usr/share/applications/


# æ›´æ–°åŽ,åˆ é™¤ç‰¹å®šæ–‡ä»¶
if [[ -n "$XDG_CURRENT_DESKTOP" && "$XDG_CURRENT_DESKTOP" =~ "KDE" ]]; then
  echo "âœ… å½“å‰æ˜¯KDEæ¡Œé¢çŽ¯å¢ƒ (XDG_CURRENT_DESKTOP=$XDG_CURRENT_DESKTOP)"

  # è¦åˆ é™¤çš„æ–‡ä»¶æ•°ç»„ï¼ˆæ”¯æŒé€šé…ç¬¦å’Œç›¸å¯¹è·¯å¾„ï¼‰
  files_to_delete=(
    "$HOME/.config/autostart/terminal.desktop"
  )

  # ==================================================
  # æ–‡ä»¶åˆ é™¤å‡½æ•°ï¼ˆæ”¯æŒKDEå›žæ”¶ç«™ï¼‰
  # ==================================================
  function delete_files() {
    local files=("${(@)files_to_delete}")  # ä½¿ç”¨æ•°ç»„å‚æ•°

    # æ£€æµ‹KDEçŽ¯å¢ƒ
    if [[ "$XDG_CURRENT_DESKTOP" =~ "KDE" ]]; then
      print -P "%F{blue}âœ“ æ£€æµ‹åˆ°KDEçŽ¯å¢ƒ: ä½¿ç”¨å›žæ”¶ç«™åŠŸèƒ½%f"

      # æ£€æŸ¥kioclientæ˜¯å¦å¯ç”¨
      if ! command -v kioclient &>/dev/null; then
        print -P "%F{red}âœ— éœ€è¦å®‰è£…kioåŒ…: sudo apt install kio%f" >&2
        return 1
      fi

      # å¤„ç†æ•°ç»„ä¸­çš„æ–‡ä»¶
      for pattern in "${files[@]}"; do
        # æ‰©å±•é€šé…ç¬¦ï¼ˆæ”¯æŒ~/*.tmpç­‰è¡¨è¾¾å¼ï¼‰
        expanded_files=(${~pattern}(N))

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [[ ${#expanded_files[@]} -eq 0 ]]; then
          print -P "%F{yellow}âš  è·¯å¾„æœªæ‰¾åˆ°: $pattern%f"
          continue
        fi

        # é€æ–‡ä»¶æ“ä½œ
        for file in "${expanded_files[@]}"; do
          absolute_path=${(e)~file:a}  # èŽ·å–ç»å¯¹è·¯å¾„

          # æ‰§è¡Œå›žæ”¶ç«™æ“ä½œ
          kioclient move "$absolute_path" trash:/ && \
            print -P "%F{green}â™»ï¸ å·²ç§»è‡³å›žæ”¶ç«™: $absolute_path to trash:/%f" || \
            print -P "%F{red}âœ— åˆ é™¤å¤±è´¥: $absolute_path%f" >&2
        done
      done

    else
      # éžKDEçŽ¯å¢ƒç›´æŽ¥åˆ é™¤
      print -P "%F{yellow}âš  éžKDEçŽ¯å¢ƒ: æ°¸ä¹…åˆ é™¤æ–‡ä»¶%f"

      for pattern in "${files[@]}"; do
        expanded_files=(${~pattern}(N))

        for file in "${expanded_files[@]}"; do
          rm -v -- "$file" && \
            print -P "%F{blue}?ï¸ å·²åˆ é™¤: ${file:a}%f" || \
            print -P "%F{red}âœ— åˆ é™¤å¤±è´¥: ${file:a}%f" >&2
        done
      done
    fi
  }

  delete_files files_to_delete
fi
